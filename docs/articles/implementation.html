<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>How interactive complex heatmap is implemented • InteractiveComplexHeatmap</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="How interactive complex heatmap is implemented">
<meta property="og:description" content="InteractiveComplexHeatmap">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">InteractiveComplexHeatmap</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.11.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/InteractiveComplexHeatmap_intro.html">How to visualize complex heatmaps interactively</a>
    </li>
    <li>
      <a href="../articles/implementation.html">How interactive complex heatmap is implemented</a>
    </li>
    <li>
      <a href="../articles/shiny_dev.html">Functions for Shiny app development</a>
    </li>
    <li>
      <a href="../articles/decoration.html">Decorations on heatmaps</a>
    </li>
    <li>
      <a href="../articles/interactivate_indirect.html">Interactivate heatmaps indirectly generated by pheatmap(), heatmap.2() and heatmap()</a>
    </li>
    <li>
      <a href="../articles/deseq2_app.html">A Shiny app for visualizing DESeq2 results</a>
    </li>
    <li>
      <a href="../articles/from_scratch.html">Implement interactive heatmap from scratch</a>
    </li>
    <li>
      <a href="../articles/share.html">Share interactive heatmaps to collaborators</a>
    </li>
    <li>
      <a href="https://www.biorxiv.org/content/10.1101/2021.03.08.434289v7.full.pdf" class="external-link">PDF version</a>
    </li>
  </ul>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jokergoo/InteractiveComplexHeatmap/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>How interactive complex heatmap is implemented</h1>
                        <h4 data-toc-skip class="author">Zuguang Gu ( <a href="mailto:z.gu@dkfz.de" class="email">z.gu@dkfz.de</a> )</h4>
            
            <h4 data-toc-skip class="date">2024-02-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/jokergoo/InteractiveComplexHeatmap/blob/HEAD/vignettes/implementation.Rmd" class="external-link"><code>vignettes/implementation.Rmd</code></a></small>
      <div class="hidden name"><code>implementation.Rmd</code></div>

    </div>

    
    
<style>
p {
    margin: 1em 0;
}
img {
    background-color: #FFFFFF;
    padding: 2px;
    border: 1px solid #DDDDDD;
    border-radius: 3px;
    border: 1px solid #CCCCCC;
    margin: 0 5px;
}
</style>
<p>Heatmaps are mainly for visualizing common patterns that are shared by groups of rows and columns. After the patterns are observed, the next step is to extract the corresponding groups of rows and columns from the heatmap, which requires interactivity on the heatmaps. The <strong>ComplexHeatmap</strong> package is well known for generating <strong>static heatmaps</strong> (a single heatmap or a list of heatmaps, possibly with complex annotations). Here the package <strong>InteractiveComplexHeatmap</strong> brings interactivity to <strong>ComplexHeatmap</strong>. The new functionalities allow users to capture sub-heatmaps by clicking/hovering single cells or selecting areas from heatmaps.</p>
<p>Unlike other packages which support interactive heatmaps based on JavaScript, <em>e.g.</em>, <strong>iheatmapr</strong>, <strong>heatmaply</strong> and <strong>d3heatmap</strong>, the package <strong>InteractiveComplexHeatmap</strong> has a special way to capture the positions that users selected and to extract the corresponding values from the matrices. In this vignette, I will explain in details how the interactivity is implemented based on <strong>ComplexHeatmap</strong>.</p>
<p>To demonstrate it, I first generate a list of two heatmaps and apply <em>k</em>-means clustering on the numeric heatmap.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/ComplexHeatmap" class="external-link">ComplexHeatmap</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jokergoo/InteractiveComplexHeatmap" class="external-link">InteractiveComplexHeatmap</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">mat1</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">mat1</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mat1</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span><span class="va">mat2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">letters</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">]</span>, <span class="fl">100</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">mat2</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">mat2</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"b"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ht_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html" class="external-link">Heatmap</a></span><span class="op">(</span><span class="va">mat1</span>, name <span class="op">=</span> <span class="st">"mat_a"</span>, row_km <span class="op">=</span> <span class="fl">2</span>, column_km <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/Heatmap.html" class="external-link">Heatmap</a></span><span class="op">(</span><span class="va">mat2</span>, name <span class="op">=</span> <span class="st">"mat_b"</span><span class="op">)</span></span></code></pre></div>
<p><strong>InteractiveComplexHeatmap</strong> implements two types of interactivity:</p>
<ol style="list-style-type: decimal">
<li>on the interactive graphics device,</li>
<li>on a Shiny app.</li>
</ol>
<p>The interactivity on the interactive graphics device is the basis of the interactivity of the Shiny app, so in the following sections, I will first introduce how the interactivity is implemneted with the interactive graphics device.</p>
<div class="section level2">
<h2 id="on-the-interactive-graphics-device">On the interactive graphics device<a class="anchor" aria-label="anchor" href="#on-the-interactive-graphics-device"></a>
</h2>
<p>Here the “interactive graphics device” is the window that is opened for generating plots in your R session if you use R in the terminal or in a native R GUI, or the figure panel in Rstudio IDE.</p>
<p>I will first explain how <strong>InteractiveComplexHeatmap</strong> captures the positions that user clicked on the device and how it is associated to the values in the matrix.</p>
<p>When user clicks on the device, the physical locations relative in the device (offsets to the bottom left of the device on both x and y directions) are captured by <code><a href="https://rdrr.io/r/grid/grid.locator.html" class="external-link">grid::grid.locator()</a></code>. The physical locations of the heatmaps (more precisely, the heatmap slices) can also be captured by <code><a href="https://rdrr.io/r/grid/deviceLoc.html" class="external-link">grid::deviceLoc()</a></code>. With knowing the exact positions of the clicked points and the heatmaps, it is possible to tell which heatmap the clicked points are in. Furthermore, by calculating the relative distance of the clicked points in that heatmap, it is also possible to know which rows and columns the clicked points correspond to.</p>
<p>For associating user’s clicked points and the heatmaps, we first need to calculate the positions of all heatmaps. There is a helper function <code><a href="../reference/htPositionsOnDevice.html">htPositionsOnDevice()</a></code> that does this job.</p>
<p>Before executing <code><a href="../reference/htPositionsOnDevice.html">htPositionsOnDevice()</a></code>, the heatmap should be drawn on the device and the layout of heatmaps should have been generated so that <code><a href="../reference/htPositionsOnDevice.html">htPositionsOnDevice()</a></code> can access various viewports of the plot. Thus, the heatmap object <code>ht_list</code> should be updated explicitly by the <code><a href="https://rdrr.io/pkg/ComplexHeatmap/man/draw-dispatch.html" class="external-link">draw()</a></code> function.</p>
<p>The following code draws the heatmap in a device with 6 inches width and 4 inches height.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ht_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/draw-dispatch.html" class="external-link">draw</a></span><span class="op">(</span><span class="va">ht_list</span><span class="op">)</span></span>
<span><span class="va">pos</span> <span class="op">=</span> <span class="fu"><a href="../reference/htPositionsOnDevice.html">htPositionsOnDevice</a></span><span class="op">(</span><span class="va">ht_list</span><span class="op">)</span></span></code></pre></div>
<p><img src="implementation_files/figure-html/unnamed-chunk-3-1.png" width="576" style="display: block; margin: auto;"></p>
<p>The returned object <code>pos</code> is a <code>DataFrame</code> object that contains the positions of all heatmap slices. A <code>DataFrame</code> object (the <code>DataFrame</code> class is defined in <a href="https://bioconductor.org/packages/release/bioc/html/S4Vectors.html" class="external-link"><strong>S4Vectors</strong> package</a>) is bacially very similar to a data frame, but it can store more complex data types, such as the <code>simpleUnit</code> vectors (generated by <code><a href="https://rdrr.io/r/grid/unit.html" class="external-link">grid::unit()</a></code>).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pos</span></span></code></pre></div>
<pre><code><span><span class="co">## DataFrame with 6 rows and 8 columns</span></span>
<span><span class="co">##       heatmap                  slice row_slice column_slice</span></span>
<span><span class="co">##   &lt;character&gt;            &lt;character&gt; &lt;integer&gt;    &lt;integer&gt;</span></span>
<span><span class="co">## 1       mat_a mat_a_heatmap_body_1_1         1            1</span></span>
<span><span class="co">## 2       mat_a mat_a_heatmap_body_1_2         1            2</span></span>
<span><span class="co">## 3       mat_a mat_a_heatmap_body_2_1         2            1</span></span>
<span><span class="co">## 4       mat_a mat_a_heatmap_body_2_2         2            2</span></span>
<span><span class="co">## 5       mat_b mat_b_heatmap_body_1_1         1            1</span></span>
<span><span class="co">## 6       mat_b mat_b_heatmap_body_2_1         2            1</span></span>
<span><span class="co">##                    x_min                  x_max                  y_min</span></span>
<span><span class="co">##             &lt;simpleUnit&gt;           &lt;simpleUnit&gt;           &lt;simpleUnit&gt;</span></span>
<span><span class="co">## 1 0.732318701591533inc.. 1.77971604907863inches  1.0313072492669inches</span></span>
<span><span class="co">## 2 1.81908612781879inches 2.86648347530589inches  1.0313072492669inches</span></span>
<span><span class="co">## 3 0.732318701591533inc.. 1.77971604907863inches 0.432843658241349inc..</span></span>
<span><span class="co">## 4 1.81908612781879inches 2.86648347530589inches 0.432843658241349inc..</span></span>
<span><span class="co">## 5  2.9452236327862inches 5.07938840650056inches  1.0313072492669inches</span></span>
<span><span class="co">## 6  2.9452236327862inches 5.07938840650056inches 0.432843658241349inc..</span></span>
<span><span class="co">##                    y_max</span></span>
<span><span class="co">##             &lt;simpleUnit&gt;</span></span>
<span><span class="co">## 1 3.26768129840847inches</span></span>
<span><span class="co">## 2 3.26768129840847inches</span></span>
<span><span class="co">## 3 0.991937170526741inc..</span></span>
<span><span class="co">## 4 0.991937170526741inc..</span></span>
<span><span class="co">## 5 3.26768129840847inches</span></span>
<span><span class="co">## 6 0.991937170526741inc..</span></span></code></pre>
<p>We can confirm whether the positions are correctly captured by the following code. In the next figure, black rectangles correspond to the heatmap slices and the dashed rectangle corresponds to the border of the whole image.</p>
<p><img src="implementation_files/figure-html/unnamed-chunk-5-1.png" width="576" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.new</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">6</span>, height <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.newpage.html" class="external-link">grid.newpage</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grid/grid.rect.html" class="external-link">grid.rect</a></span><span class="op">(</span>gp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/gpar.html" class="external-link">gpar</a></span><span class="op">(</span>lty <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pos</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x_min</span> <span class="op">=</span> <span class="va">pos</span><span class="op">[</span><span class="va">i</span>, <span class="st">"x_min"</span><span class="op">]</span></span>
<span>    <span class="va">x_max</span> <span class="op">=</span> <span class="va">pos</span><span class="op">[</span><span class="va">i</span>, <span class="st">"x_max"</span><span class="op">]</span></span>
<span>    <span class="va">y_min</span> <span class="op">=</span> <span class="va">pos</span><span class="op">[</span><span class="va">i</span>, <span class="st">"y_min"</span><span class="op">]</span></span>
<span>    <span class="va">y_max</span> <span class="op">=</span> <span class="va">pos</span><span class="op">[</span><span class="va">i</span>, <span class="st">"y_max"</span><span class="op">]</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/viewports.html" class="external-link">pushViewport</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/grid/viewport.html" class="external-link">viewport</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x_min</span>, y <span class="op">=</span> <span class="va">y_min</span>, name <span class="op">=</span> <span class="va">pos</span><span class="op">[</span><span class="va">i</span>, <span class="st">"slice"</span><span class="op">]</span>,</span>
<span>        width <span class="op">=</span> <span class="va">x_max</span> <span class="op">-</span> <span class="va">x_min</span>, height <span class="op">=</span> <span class="va">y_max</span> <span class="op">-</span> <span class="va">y_min</span>,</span>
<span>        just <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"left"</span>, <span class="st">"bottom"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/grid.rect.html" class="external-link">grid.rect</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/grid/viewports.html" class="external-link">upViewport</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Yes, the positions of all heatmap slices are correctly captured!</p>
<p>Since now we know the location of the clicked points (by <code><a href="https://rdrr.io/r/grid/grid.locator.html" class="external-link">grid::grid.locator()</a></code>) and the positions of all heatmap slices, it is possible to calculate which row and which column in the original matrix user’s click corresponds to.</p>
<p>In the next figure, the blue point with the coordinate <span class="math inline">\((a, b)\)</span> is clicked by user. The heatmap slice where user clicked into has range <span class="math inline">\((x_1,x_2)\)</span> on x direction and range <span class="math inline">\((y_1, y_2)\)</span> on y direction and this heatmap slice can be easily found by comparing the locations of every heatmap slice to the position of the click. There are <span class="math inline">\(n_r\)</span> rows (<span class="math inline">\(n_r =8\)</span>) and <span class="math inline">\(n_c\)</span> columns (<span class="math inline">\(n_c = 5\)</span>) in this heatmap slice and they are marked by dashed lines. Note all the coordinate values (<em>i.e.</em>, <span class="math inline">\(a\)</span>, <span class="math inline">\(b\)</span>, <span class="math inline">\(x_1\)</span>, <span class="math inline">\(y_1\)</span>, <span class="math inline">\(x_2\)</span> and <span class="math inline">\(y_2\)</span>) are measured as the physical positions in the graphics device.</p>
<p><img src="implementation_files/figure-html/unnamed-chunk-7-1.png" width="576" style="display: block; margin: auto;"></p>
<p>In this heatmap slice, the row index <span class="math inline">\(i_r\)</span> and column index <span class="math inline">\(i_c\)</span> of the cell where the point is in can be calculated as (assume the left bottom corresponds to the index of 1 for both rows and columns):</p>
<p><span class="math display">\[ i_c = \lceil \frac{a - x_1}{x_2 - x_1} \cdot n_c \rceil \]</span> <span class="math display">\[ i_r = \lceil \frac{b - y_1}{y_2 - y_1} \cdot n_r \rceil \]</span></p>
<p>where the symbol <span class="math inline">\(\lceil x \rceil\)</span> means the ceiling of the numeric value <span class="math inline">\(x\)</span>. In <strong>ComplexHeatmap</strong>, the row with index 1 is always put on the top of the heatmap, then <span class="math inline">\(i_r\)</span> should be adjusted as:</p>
<p><span class="math display">\[ i_r = n_r - \lceil \frac{b - y_1}{y_2 - y_1} \cdot n_r \rceil + 1 \]</span></p>
<p>The subset of row and column indices of the original matrix that belongs to the selected heatmap slice is already stored in <code>ht_list</code> object (they can be retrieved by <code><a href="https://rdrr.io/pkg/ComplexHeatmap/man/row_order-dispatch.html" class="external-link">row_order()</a></code> and <code><a href="https://rdrr.io/pkg/ComplexHeatmap/man/column_order-dispatch.html" class="external-link">column_order()</a></code> function), thus, we can obtain the row and column index of the original matrix that corresponds to user’s point easily with <span class="math inline">\(i_r\)</span> and <span class="math inline">\(i_c\)</span>.</p>
<p>Denote the matrix for the complete heatmap (without slicing) as <span class="math inline">\(M\)</span>, and denote the subset of row and column indices in that heatmap as <span class="math inline">\(o^{\mathrm{row}}\)</span> and <span class="math inline">\(o^{\mathrm{col}}\)</span>. Note, <span class="math inline">\(o^{\mathrm{row}}\)</span> and <span class="math inline">\(o^{\mathrm{col}}\)</span> can be reordered due to clustering. Then the row and column indices (<span class="math inline">\(j_r\)</span> and <span class="math inline">\(j_c\)</span>) for the selected point in <span class="math inline">\(M\)</span> are</p>
<p><span class="math display">\[j_r = o^{\mathrm{row}}_{i_r}\]</span> <span class="math display">\[j_c = o^{\mathrm{col}}_{i_c}\]</span></p>
<p>And the corresponding value in <span class="math inline">\(M\)</span> is <span class="math inline">\(M_{j_r, j_c}\)</span>.</p>
<p><strong>InteractiveComplexHeatmap</strong> has two functions <code><a href="../reference/selectPosition.html">selectPosition()</a></code> and <code><a href="../reference/selectArea.html">selectArea()</a></code> which allow users to pick single positions or select areas from the heatmaps. Under the interactive graphics device, users do not need to run <code><a href="../reference/htPositionsOnDevice.html">htPositionsOnDevice()</a></code> explicitly. The positions of heatmaps are automatically calculated, cached and reused if the heatmaps are the same and the device has not changed its size. If users changed the device size, <code><a href="../reference/htPositionsOnDevice.html">htPositionsOnDevice()</a></code> will be automatically re-executed.</p>
<p>The next image shows an example of using <code><a href="../reference/selectPosition.html">selectPosition()</a></code>.</p>
<script>
document.write('<img width="100%" src="https://jokergoo.github.io/images/example1.gif" />');
</script><p>Interactively, the function asks user to click one position on the heatmap. The function returns a <code>DataFrame</code> which contains the heatmap name, slice name and the row/column index of the matrix in that heatmap.</p>
<pre><code><span><span class="co">## DataFrame with 1 row and 6 columns</span></span>
<span><span class="co">##       heatmap                  slice row_slice column_slice row_index</span></span>
<span><span class="co">##   &lt;character&gt;            &lt;character&gt; &lt;numeric&gt;    &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1       mat_a mat_a_heatmap_body_1_2         1            2         9</span></span>
<span><span class="co">##   column_index</span></span>
<span><span class="co">##      &lt;integer&gt;</span></span>
<span><span class="co">## 1            1</span></span></code></pre>
<p>The output means, the position user clicked is in a heatmap called “mat_a”, in its first row slice and the second column slice. Assume <code>mat</code> is the matrix sent to heatmap “mat_a”, then the clicked point correspond to the value <code>mat[9, 1]</code>.</p>
<p>If the position clicked is not in any of the heatmap slices, the function returns <code>NULL</code>.</p>
<p>Similarly, the <code><a href="../reference/selectArea.html">selectArea()</a></code> function asks user to click two positions on the heatmap which defines an area.</p>
<script>
document.write('<img width="100%" src="https://jokergoo.github.io/images/example2.gif" />');
</script><p>Note since the selected area may overlap over multiple heatmaps and slices, the function returns a <code>DataFrame</code> with multiple rows which contains the heatmap names, slice names and the row/column indices in that heatmap. An example output is as follows.</p>
<pre><code><span><span class="co">## DataFrame with 4 rows and 6 columns</span></span>
<span><span class="co">##       heatmap                  slice row_slice column_slice     row_index</span></span>
<span><span class="co">##   &lt;character&gt;            &lt;character&gt; &lt;numeric&gt;    &lt;numeric&gt; &lt;IntegerList&gt;</span></span>
<span><span class="co">## 1       mat_a mat_a_heatmap_body_1_2         1            2     7,5,2,...</span></span>
<span><span class="co">## 2       mat_a mat_a_heatmap_body_2_2         2            2           6,3</span></span>
<span><span class="co">## 3       mat_b mat_b_heatmap_body_1_1         1            1     7,5,2,...</span></span>
<span><span class="co">## 4       mat_b mat_b_heatmap_body_2_1         2            1           6,3</span></span>
<span><span class="co">##    column_index</span></span>
<span><span class="co">##   &lt;IntegerList&gt;</span></span>
<span><span class="co">## 1     2,4,1,...</span></span>
<span><span class="co">## 2     2,4,1,...</span></span>
<span><span class="co">## 3     1,2,3,...</span></span>
<span><span class="co">## 4     1,2,3,...</span></span></code></pre>
<p>The columns <code>row_index</code> and <code>column_index</code> are stored in <code>IntegerList</code> format. To get the row indices in <em>e.g.</em> <code>mat_a_heatmap_body_1_2</code> (in the first row), user can use either one of the following command (assume the <code>DataFrame</code> object is called <code>df</code>):</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">df</span><span class="op">[</span><span class="fl">1</span>, <span class="st">"row_index"</span><span class="op">]</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">df</span><span class="op">[</span><span class="fl">1</span>, <span class="st">"row_index"</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">df</span><span class="op">$</span><span class="va">row_index</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<p>The rectangle and the points that mark the area can be turned off by setting <code>mark</code> argument to <code>FALSE</code>.</p>
</div>
<div class="section level2">
<h2 id="on-off-screen-graphics-devices">On off-screen graphics devices<a class="anchor" aria-label="anchor" href="#on-off-screen-graphics-devices"></a>
</h2>
<p>It is also possible to use <code><a href="../reference/selectPosition.html">selectPosition()</a></code> and <code><a href="../reference/selectArea.html">selectArea()</a></code> on other off-screen graphics devices, such as <code><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf()</a></code> or <code><a href="https://rdrr.io/r/grDevices/png.html" class="external-link">png()</a></code>. Now you cannot select the positions interactively, but instead you can specify <code>pos</code> argument in <code><a href="../reference/selectPosition.html">selectPosition()</a></code> and <code>pos1</code>/<code>pos2</code> in <code><a href="../reference/selectArea.html">selectArea()</a></code> to simulate clicks. The values for <code>pos</code>, <code>pos1</code> and <code>pos2</code> all should be a <code>unit</code> object of length two which correspond to the x and y coordinate of the positions.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span><span class="va">ht_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/draw-dispatch.html" class="external-link">draw</a></span><span class="op">(</span><span class="va">ht_list</span><span class="op">)</span></span>
<span><span class="va">pos</span> <span class="op">=</span> <span class="fu"><a href="../reference/selectPosition.html">selectPosition</a></span><span class="op">(</span><span class="va">ht_list</span>, pos <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="implementation_files/figure-html/unnamed-chunk-10-1.png" width="576" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">##   Point: x = 3.0 cm, y = 3.0 cm (measured in the graphics device)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## The heatmaps have been changed. Calculate new heatmap positions.</span></span>
<span><span class="co">## Search in heatmap 'mat_a'</span></span>
<span><span class="co">##   - row slice 1, column slice 1 [mat_a_heatmap_body_1_1]... overlap</span></span></code></pre>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pos</span></span></code></pre></div>
<pre><code><span><span class="co">## DataFrame with 1 row and 8 columns</span></span>
<span><span class="co">##       heatmap                  slice row_slice column_slice row_index</span></span>
<span><span class="co">##   &lt;character&gt;            &lt;character&gt; &lt;numeric&gt;    &lt;numeric&gt; &lt;integer&gt;</span></span>
<span><span class="co">## 1       mat_a mat_a_heatmap_body_1_1         1            1         8</span></span>
<span><span class="co">##   column_index   row_label column_label</span></span>
<span><span class="co">##      &lt;integer&gt; &lt;character&gt;  &lt;character&gt;</span></span>
<span><span class="co">## 1            7          a8           a7</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/grDevices/pdf.html" class="external-link">pdf</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span><span class="va">ht_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/ComplexHeatmap/man/draw-dispatch.html" class="external-link">draw</a></span><span class="op">(</span><span class="va">ht_list</span><span class="op">)</span></span>
<span><span class="va">pos</span> <span class="op">=</span> <span class="fu"><a href="../reference/selectArea.html">selectArea</a></span><span class="op">(</span><span class="va">ht_list</span>, pos1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span>, <span class="st">"cm"</span><span class="op">)</span>, pos2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/grDevices/dev.html" class="external-link">dev.off</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="implementation_files/figure-html/unnamed-chunk-13-1.png" width="576" style="display: block; margin: auto;"></p>
<pre><code><span><span class="co">##   Point 1: x = 3.0 cm, y = 3.0 cm (measured in the graphics device)</span></span>
<span><span class="co">##   Point 2: x = 5.0 cm, y = 5.0 cm (measured in the graphics device)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Heatmap positions are already calculated, use the cached one.</span></span>
<span><span class="co">## Search in heatmap 'mat_a'</span></span>
<span><span class="co">##   - row slice 1, column slice 1 [mat_a_heatmap_body_1_1]... overlap</span></span>
<span><span class="co">## Search in heatmap 'mat_a'</span></span>
<span><span class="co">##   - row slice 1, column slice 2 [mat_a_heatmap_body_1_2]... overlap</span></span>
<span><span class="co">## Search in heatmap 'mat_a'</span></span>
<span><span class="co">##   - row slice 2, column slice 1 [mat_a_heatmap_body_2_1]... no overlap</span></span>
<span><span class="co">## Search in heatmap 'mat_a'</span></span>
<span><span class="co">##   - row slice 2, column slice 2 [mat_a_heatmap_body_2_2]... no overlap</span></span>
<span><span class="co">## Search in heatmap 'mat_b'</span></span>
<span><span class="co">##   - row slice 1, column slice 1 [mat_b_heatmap_body_1_1]... no overlap</span></span>
<span><span class="co">## Search in heatmap 'mat_b'</span></span>
<span><span class="co">##   - row slice 2, column slice 1 [mat_b_heatmap_body_2_1]... no overlap</span></span></code></pre>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pos</span></span></code></pre></div>
<pre><code><span><span class="co">## DataFrame with 2 rows and 8 columns</span></span>
<span><span class="co">##       heatmap                  slice row_slice column_slice     row_index</span></span>
<span><span class="co">##   &lt;character&gt;            &lt;character&gt; &lt;numeric&gt;    &lt;numeric&gt; &lt;IntegerList&gt;</span></span>
<span><span class="co">## 1       mat_a mat_a_heatmap_body_1_1         1            1     7,5,2,...</span></span>
<span><span class="co">## 2       mat_a mat_a_heatmap_body_1_2         1            2     7,5,2,...</span></span>
<span><span class="co">##    column_index       row_label    column_label</span></span>
<span><span class="co">##   &lt;IntegerList&gt; &lt;CharacterList&gt; &lt;CharacterList&gt;</span></span>
<span><span class="co">## 1         7,3,5    a7,a5,a2,...        a7,a3,a5</span></span>
<span><span class="co">## 2             6    a7,a5,a2,...              a6</span></span></code></pre>
<p>Users do not need to use this functionality directly with an off-screen graphics device, however, it is very useful when developing a Shiny app where the plot is actually generated under an off-screen graphics device. I will explain it in the next section.</p>
</div>
<div class="section level2">
<h2 id="shiny-app">Shiny app<a class="anchor" aria-label="anchor" href="#shiny-app"></a>
</h2>
<p>With the three functions <code><a href="../reference/htPositionsOnDevice.html">htPositionsOnDevice()</a></code>, <code><a href="../reference/selectPosition.html">selectPosition()</a></code> and <code><a href="../reference/selectArea.html">selectArea()</a></code>, it is possible to implement Shiny apps for interactively working with heatmaps. Now the problem is how does the server side capture the positions that user clicked on the web page. Luckily, there is a solution for this. The output heatmap is normally put within a <code><a href="https://rdrr.io/pkg/shiny/man/plotOutput.html" class="external-link">shiny::plotOutput()</a></code> and <code><a href="https://rdrr.io/pkg/shiny/man/plotOutput.html" class="external-link">plotOutput()</a></code> provides two actions <code>click</code> and <code>brush</code>. Then on the server side, it is possible to get the information of the positions that user clicked. The positions can then be set to <code><a href="../reference/selectPosition.html">selectPosition()</a></code> and <code><a href="../reference/selectArea.html">selectArea()</a></code> via <code>pos</code> or <code>pos1</code>/<code>pos2</code> arguments to correctly correspond to the values in original matrices.</p>
<p><br><br><br><br><br><br><br><br></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Zuguang Gu.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  


  <style>nav[data-toggle='toc'] .nav .nav {display: block;}</style>
</body>
</html>
